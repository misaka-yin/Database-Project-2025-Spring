<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Events - PAL Library</title>
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .tabs {
      display: flex;
      margin-bottom: 20px;
    }

    .tab-button {
      padding: 10px 20px;
      border: 1px solid #ccc;
      background-color: #f0f0f0;
      cursor: pointer;
      border-radius: 5px 5px 0 0;
    }

    .tab-button.active {
      background-color: #ddd;
      border-bottom: none;
    }

    .tab-content {
      border: 1px solid #ccc;
      padding: 20px;
    }

    .filter-controls {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .event-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
    }

    .event-table th,
    .event-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    .pagination {
      display: flex;
      gap: 5px;
      justify-content: center;
    }

    .pagination button {
      padding: 5px 10px;
      cursor: pointer;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>

<body id="events">
  <header class="header">
    <div class="header__container">
      <a href="index.html" class="header__logo">
        <img src="assets/images/logo.png" alt="PAL Logo" height="40">
      </a>
      <nav class="header__nav">
        <ul class="nav__list">
          <li><a href="index.html" class="nav__link">Home</a></li>
          <li><a href="catalog.html" class="nav__link">Catalog</a></li>
          <li><a href="authors.html" class="nav__link">Authors</a></li>
          <li><a href="topics.html" class="nav__link">Topics</a></li>
          <li><a href="inventory.html" class="nav__link">Inventory</a></li>
          <li><a href="rentals.html" class="nav__link">My Rentals</a></li>
          <li><a href="events.html" class="nav__link nav__link--active">Events</a></li>
          <li><a href="reservations.html" class="nav__link nav__link--active">Reservations</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <section class="section">
      <h1 class="section__title">Events</h1>
      <div class="tabs">
        <button class="tab-button active" data-tab="seminar">Seminar</button>
        <button class="tab-button" data-tab="exhibition">Exhibition</button>
      </div>

      <div id="seminar-tab" class="tab-content">
        <div class="filter-controls">
          <label for="seminarTopicFilter">Topic:</label>
          <select id="seminarTopicFilter">
            <option value="">All Topics</option>
          </select>
          <label for="seminarStatusFilter">Status:</label>
          <select id="seminarStatusFilter">
            <option value="">All</option>
            <option value="upcoming">Upcoming</option>
            <option value="past">Past</option>
          </select>
        </div>
        <div id="seminarTableContainer">
        </div>
        <div class="pagination" id="seminarPagination">
        </div>
      </div>

      <div id="exhibition-tab" class="tab-content hidden">
        <div class="filter-controls">
          <label for="seminarTopicFilter">Topic:</label>
          <select id="seminarTopicFilter">
            <option value="">All Topics</option>
          </select>
          <label for="exhibitionStatusFilter">Status:</label>
          <select id="exhibitionStatusFilter">
            <option value="">All</option>
            <option value="upcoming">Upcoming</option>
            <option value="past">Past</option>
          </select>
        </div>
        <div id="exhibitionTableContainer">
        </div>
        <div class="pagination" id="exhibitionPagination">
        </div>
      </div>
    </section>
  </main>

  <div id="eventModal" class="modal hidden">
    <div class="modal__content">
      <span class="modal__close" id="modalClose">&times;</span>
      <div id="modalBody">
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="footer__container">
      <p>Â© 2025 PAL Library. All rights reserved.</p>
    </div>
  </footer>

  <script src="js/main.js"></script>
  <script>
    const allEvents = []; // Store all fetched events
    const eventsPerPage = 10;
    let currentSeminarPage = 1;
    let currentExhibitionPage = 1;
    let currentTab = 'seminar';

    // Function to determine if an event is upcoming or past
    function getEventStatus(event) {
      const now = new Date();
      const endDate = new Date(event.stop_datetime);
      return endDate > now ? 'upcoming' : 'past';
    }

    async function loadEvents() {
      try {
        const eventsData = await apiGet('/api/events');
        allEvents.push(...eventsData);
        populateSeminarTopicFilter(eventsData);
        filterAndDisplaySeminars();
        filterAndDisplayExhibitions();
      } catch (e) {
        console.error('Failed to load events', e);
      }
    }

    function populateSeminarTopicFilter(events) {
      const seminarTopicFilter = document.getElementById('seminarTopicFilter');
      const topics = [...new Set(events.filter(e => e.type === 'Seminar').map(e => e.topic))];
      topics.forEach(topic => {
        const option = document.createElement('option');
        option.value = topic;
        option.textContent = topic;
        seminarTopicFilter.appendChild(option);
      });
    }

    function filterSeminars(events, topicFilter, statusFilter) {
      return events.filter(event => {
        if (event.type !== 'Seminar') return false;
        const topicMatch = !topicFilter || event.topic === topicFilter;
        const status = getEventStatus(event);
        const statusMatch = !statusFilter || status === statusFilter;
        return topicMatch && statusMatch;
      });
    }

    function displaySeminarTable(seminars, page) {
      const seminarTableContainer = document.getElementById('seminarTableContainer');
      seminarTableContainer.innerHTML = '';
      if (seminars.length === 0) {
        seminarTableContainer.innerHTML = '<p>No seminars found.</p>';
        document.getElementById('seminarPagination').innerHTML = '';
        return;
      }

      const startIndex = (page - 1) * eventsPerPage;
      const endIndex = Math.min(startIndex + eventsPerPage, seminars.length);
      const currentSeminars = seminars.slice(startIndex, endIndex);

      const table = document.createElement('table');
      table.className = 'event-table';
      table.innerHTML = `
                <thead>
                    <tr>
                        <th>Seminar Title</th>
                        <th>Type</th>
                        <th>Sponsor</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Invited Attendees</th>
                    </tr>
                </thead>
                <tbody>
                    ${currentSeminars.map(seminar => `
                        <tr>
                            <td>${seminar.name}</td>
                            <td>${seminar.type}</td>
                            <td><button class="btn btn--secondary btn--small" onclick="viewSponsors(${seminar.id})">View</button></td>
                            <td>${new Date(seminar.start_datetime).toLocaleDateString()}</td>
                            <td>${new Date(seminar.start_datetime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} - ${new Date(seminar.stop_datetime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
                            <td>${seminar.invited_attendees ? seminar.invited_attendees.join(', ') : 'N/A'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
      seminarTableContainer.appendChild(table);
      renderSeminarPagination(seminars.length, page);
    }

    function renderSeminarPagination(totalEvents, currentPage) {
      const seminarPagination = document.getElementById('seminarPagination');
      seminarPagination.innerHTML = '';
      const totalPages = Math.ceil(totalEvents / eventsPerPage);

      for (let i = 1; i <= totalPages; i++) {
        const button = document.createElement('button');
        button.textContent = i;
        if (i === currentPage) {
          button.classList.add('active');
        }
        button.addEventListener('click', () => {
          currentSeminarPage = i;
          filterAndDisplaySeminars();
        });
        seminarPagination.appendChild(button);
      }
    }

    function filterAndDisplaySeminars() {
      const topicFilter = document.getElementById('seminarTopicFilter').value;
      const statusFilter = document.getElementById('seminarStatusFilter').value;
      const filteredSeminars = filterSeminars(allEvents, topicFilter, statusFilter);
      displaySeminarTable(filteredSeminars, currentSeminarPage);
    }

    function filterExhibitions(events, statusFilter) {
      return events.filter(event => {
        if (event.type !== 'Exhibition') return false;
        const status = getEventStatus(event);
        const statusMatch = !statusFilter || status === statusFilter;
        return statusMatch;
      });
    }

    function displayExhibitionTable(exhibitions, page) {
      const exhibitionTableContainer = document.getElementById('exhibitionTableContainer');
      exhibitionTableContainer.innerHTML = '';
      if (exhibitions.length === 0) {
        exhibitionTableContainer.innerHTML = '<p>No exhibitions found.</p>';
        document.getElementById('exhibitionPagination').innerHTML = '';
        return;
      }

      const startIndex = (page - 1) * eventsPerPage;
      const endIndex = Math.min(startIndex + eventsPerPage, exhibitions.length);
      const currentExhibitions = exhibitions.slice(startIndex, endIndex);

      const table = document.createElement('table');
      table.className = 'event-table';
      table.innerHTML = `
                <thead>
                    <tr>
                        <th>Exhibition Title</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Register</th>
                    </tr>
                </thead>
                <tbody>
                    ${currentExhibitions.map(exhibition => `
                        <tr>
                            <td>${exhibition.name}</td>
                            <td>${new Date(exhibition.start_datetime).toLocaleDateString()}</td>
                            <td>${new Date(exhibition.start_datetime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} - ${new Date(exhibition.stop_datetime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
                            <td>
                                ${getEventStatus(exhibition) === 'upcoming'
          ? `<a href="${exhibition.registration_link}" target="_blank" class="btn btn--primary btn--small">Register</a>`
          : 'Closed'}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
      exhibitionTableContainer.appendChild(table);
      renderExhibitionPagination(exhibitions.length, page);
    }

    function renderExhibitionPagination(totalEvents, currentPage) {
      const exhibitionPagination = document.getElementById('exhibitionPagination');
      exhibitionPagination.innerHTML = '';
      const totalPages = Math.ceil(totalEvents / eventsPerPage);

      for (let i = 1; i <= totalPages; i++) {
        const button = document.createElement('button');
        button.textContent = i;
        if (i === currentPage) {
          button.classList.add('active');
        }
        button.addEventListener('click', () => {
          currentExhibitionPage = i;
          filterAndDisplayExhibitions();
        });
        exhibitionPagination.appendChild(button);
      }
    }

    function filterAndDisplayExhibitions() {
      const statusFilter = document.getElementById('exhibitionStatusFilter').value;
      const filteredExhibitions = filterExhibitions(allEvents, statusFilter);
      displayExhibitionTable(filteredExhibitions, currentExhibitionPage);
    }

    function viewSponsors(eventId) {
      // Fetch sponsor info
      apiGet(`/api/events/${eventId}/sponsors`).then(sponsors => {
        const modalBody = document.getElementById('modalBody');
        modalBody.innerHTML = `
                    <h2>Sponsors</h2>
                    <ul>${sponsors.map(s => `<li>${s.name}: $${s.amount}</li>`).join('')}</ul>
                `;
        openModal();
      });
    }

    function openModal() {
      document.getElementById('eventModal').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('eventModal').classList.add('hidden');
    }

    document.getElementById('modalClose').addEventListener('click', closeModal);

    document.addEventListener('DOMContentLoaded', () => {
      loadEvents();

      // Tab switching logic
      const tabButtons = document.querySelectorAll('.tab-button');
      const seminarTab = document.getElementById('seminar-tab');
      const exhibitionTab = document.getElementById('exhibition-tab');

      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          tabButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          const tab = button.getAttribute('data-tab');
          seminarTab.classList.toggle('hidden', tab !== 'seminar');
          exhibitionTab.classList.toggle('hidden', tab !== 'exhibition');
          currentTab = tab;
        });
      });

      // Event listeners for seminar filters
      document.getElementById('seminarTopicFilter').addEventListener('change', () => {
        currentSeminarPage = 1;
        filterAndDisplaySeminars();
      });
      document.getElementById('seminarStatusFilter').addEventListener('change', () => {
        currentSeminarPage = 1;
        filterAndDisplaySeminars();
      });

      // Event listener for exhibition filter
      document.getElementById('exhibitionStatusFilter').addEventListener('change', () => {
        currentExhibitionPage = 1;
        filterAndDisplayExhibitions();
      });
    });
  </script>
</body>

</html>